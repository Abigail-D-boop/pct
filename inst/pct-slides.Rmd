---
title: "The Propensity to Cycle Tool"
subtitle: '`r emojifont::emoji("bike")`<br/>Advanced Training Workshop'
author: "Robin Lovelace and Malcolm Morgan, University of Leeds"
date: 'London, `r Sys.Date()`<br/><img class="img-footer" alt="" src="http://www.pct.bike/www/static/01_logos/pct-logo.png">'
output:
  xaringan::moon_reader:
    # css: ["default", "its.css"]
    # chakra: libs/remark-latest.min.js
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
# bibliography: ../vignettes/ref.bib
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(RefManageR)
BibOptions(check.entries = FALSE, 
           bib.style = "authoryear", 
           cite.style = 'alphabetic', 
           style = "markdown",
           first.inits = FALSE,
           hyperlink = FALSE, 
           dashed = FALSE)
my_bib = ReadBib("../vignettes/refs.bib", check = FALSE)
```

# The PCT Advanced Workshop Team

### Robin Lovelace

- Geographer by Training
- University Academic Fellow in Transport and Big Data, Institute for Transport Studies, University of Leeds
- Lead Developer of the Propensity to Cycle Tool
- R developer and teacher, author of open source books *Efficient R Programming* and *Gecomputation with R*

--

### Malcolm Morgan

- Civil Engineer by training
- Moved into transport via the Propensity to Cycle Tool Project
- Interest in machine learning and routing
- Focus on multi-modal routing and energy use (UKERC)

--

### How about you?

---

## Housekeeping

- The venue + facilities
- The agenda + further info can be found on the pct package website: https://github.com/ITSLeeds/pct
- And the PCT training vignette: [itsleeds.github.io/pct/articles/pct_training.html](https://itsleeds.github.io/pct/articles/pct_training.html)

```{r, echo=FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/ITSLeeds/TDS/master/courses/tds-oneday_files/figure-gfm/unnamed-chunk-2-1.png")
```

---

## Learning outcomes

By the end of the course, you will be able to:

- Understand the data and code underlying the PCT
- Download data from the PCT at various geographic levels
- Use R as a tool for transport data analysis and cycle network planning

--

- Do new things with the PCT data and methods that will support the global transition away from fossil fuels `r emojifont::emoji("rocket")`

---

# Geographic levels in the PCT

- Generate and analyse route networks for transport planning with reference to:
    - Origin-destination (OD) data
    - Geographic desire lines
    - Route allocation using different routing services
    - Route network generation and analysis

---

## Transport planning software

Transport modelling software products are a vital component of modern transport planning *and* research.

- They generate the evidence base on which strategic investments are made and, furthermore,
- provide a powerful mechanism for researching alternative futures.

--

It would not be an overstatement to say that software determines the range of futures that are visible to policymakers. This makes status of transport modelling software and how it may evolve in the future important questions.

What will transport software look like? What will their capabilities be? And who will control? Answers to each of these questions will affect the future of transport systems. 

--

- Premise: transport planning/modelling software used in practice ~~will become~~ is becoming increasingly data-driven, modular and open. 

---

## A geographic perspective

- See https://github.com/ITSLeeds/TDS/blob/master/catalogue.md

- Paper on the **stplanr** paper for transport planning (available [online](https://cran.r-project.org/web/packages/stplanr/vignettes/stplanr-paper.html)) `r Citep(my_bib, "lovelace_stplanr_2017", .opts = list(cite.style = "authoryear"))`
- Introductory and advanced content on geographic data in R, especially the [transport chapter](http://geocompr.robinlovelace.net/transport.html) (available free [online](http://geocompr.robinlovelace.net/)) `r Citep(my_bib, "lovelace_geocomputation_2018", .opts = list(cite.style = "authoryear"))` 
- Paper on analysing OSM data in Python `r Citep(my_bib, "boeing_osmnx_2017", .opts = list(cite.style = "authoryear"))` (available [online](https://arxiv.org/pdf/1611.01890)) 

```{r geocompr-cover, echo=FALSE, out.width="20%"}
knitr::include_graphics("https://geocompr.robinlovelace.net/images/cover.png")
```

---


## Data science and the tidyverse

- Inspired by Introduction to data science with R (available free [online](http://r4ds.had.co.nz/)) `r Citep(my_bib, "grolemund_r_2016", .opts = list(cite.style = "authoryear"))`


```{r tds-cover, echo=FALSE, out.width="30%"}
knitr::include_graphics("https://d33wubrfki0l68.cloudfront.net/b88ef926a004b0fce72b2526b0b5c4413666a4cb/24a30/cover.png")
```

---

## Current transport software

```{r, echo=FALSE, message=FALSE, warning=FALSE}
u = "https://github.com/ITSLeeds/TDS/raw/master/transport-software.csv"
tms = readr::read_csv(u)[1:5]
tms = dplyr::arrange(tms, dplyr::desc(Citations))
knitr::kable(tms, booktabs = TRUE, caption = "Sample of transport modelling software in use by practitioners. Note: citation counts based on searches for company/developer name, the product name and 'transport'. Data source: Google Scholar searches, October 2018.", format = "html")
```

---

# Online communities

- [gis.stackexchange.com](https://gis.stackexchange.com/questions) has 21,314 questions 

- [r-sig-geo](http://r-sig-geo.2731867.n2.nabble.com/) has 1000s of posts

- RStudio's Discourse community has 65,000+ posts already!

--

- No transport equivalent (e.g. earthscience.stackexchange.com is in beta)

- Potential for a Discourse forum or similar: transport is not (just) GIS

---

background-image: url(https://media.giphy.com/media/YlQQYUIEAZ76o/giphy.gif)
background-size: cover
class: center, middle


# Applications

---

## What can you use these skills for?

- Example: the Propensity to Cycle Tool ([PCT.bike](http://www.pct.bike/)) (Lovelace et al. 2017)

```{r, echo=FALSE}
knitr::include_graphics("https://raw.githubusercontent.com/npct/pct-team/master/figures/early.png")
```

---

## How is data science used in the PCT?

- It's all reproducible, e.g.:
- Find short in which more people drive than cycle

--

- Stage 1: get data from web

```{r, eval=FALSE, echo=FALSE}
# Aim: get top 1000 lines in repo
library(dplyr)
library(sf)
desire_lines_all = pct::get_pct_lines(region = "west-yorkshire")
desire_lines = desire_lines_all %>% 
  top_n(1000, all)
write_sf(desire_lines, "desire_lines.geojson")
piggyback::pb_upload("desire_lines.geojson")
```


```{r, message=FALSE, eval=FALSE}
# Set-up, after installing pct and checking out www.pct.bike:
library(dplyr)
library(sf)
desire_lines_all = pct::get_pct_lines(region = "west-yorkshire") %>% 
  top_n(n = 1000, wt = all)
```

---

## Stage II: Geographic data analysis

- Interested only in top 200 lines in Leeds

```{r, eval=FALSE}
leeds = osmdata::getbb(place_name = "leeds", format_out = "sf_polygon")
desire_lines = desire_lines_all[leeds, , op = st_within] %>% 
  top_n(n = 200, wt = all)
```


---

## Stage III: Visualising (polution) data

<!-- A fundamental part of data science is being able to understand your data. -->

<!-- That requires visualisation, R is great for that: -->

```{r, warning=FALSE, eval=FALSE, echo=FALSE}
.pull-left[
plot(desire_lines)
]
.pull-right[
]
```


<!-- - Interactively: -->

```{r, message=FALSE, eval=FALSE}
library(tmap)
tmap_mode("view")
tm_shape(desire_lines) +
  tm_lines("all") +
  tm_basemap(server = c(leaflet::providers$OpenStreetMap, leaflet::providers$SafeCast))
```


---

## Stage IV: Origin-destination data analysis

- Now we have data in our computer, and verified it works, we can use it

- Which places are most car dependent? 

```{r, eval=FALSE}
car_dependent_routes = desire_lines %>% 
  mutate(percent_drive = car_driver / all * 100) %>% 
  filter(rf_dist_km < 3 & rf_dist_km > 1) 
```

- Get routes

```{r, eval=FALSE}
routes = stplanr::line2route(car_dependent_routes)
car_dependent_routes$geometry = routes$geometry
```

--

- Any questions?

--

- Everyone happy with RStudio?

---

# References

```{r, 'refs', results="asis", echo=FALSE}
PrintBibliography(my_bib)
# RefManageR::WriteBib(my_bib, "refs-geostat.bib")
```
